<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Baba - Badge Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d0f14;
            --bg-secondary: #161921;
            --bg-tertiary: #1f2229;
            --border-color: #2d3139;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-primary: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-progress {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .participant-count {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            background: var(--accent-light);
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .card-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 2rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .upload-area:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .upload-area.active {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }

        .upload-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .select-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            appearance: none;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .preview-area {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        #qr-hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<header class="app-header">
    <h1>Baba</h1>
    <div id="progressIndicator" class="header-progress"></div>
</header>

<div class="container">
    <!-- Step 1: Template Upload -->
    <div class="card" id="templateCard">
        <div class="card-header">
            <h2 class="card-title">Mod√®le de badge</h2>
            <p class="card-description">Importez votre template PNG de badge. Ce sera la base sur laquelle les informations seront ajout√©es.</p>
        </div>
        <div class="upload-area" id="templateUploadArea">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Cliquez pour s√©lectionner ou glissez-d√©posez</div>
            <div class="upload-hint">PNG, JPG jusqu'√† 10MB</div>
            <input type="file" id="bgInput" accept="image/*">
        </div>
        <div id="templateStatus"></div>
    </div>

    <!-- Step 2: CSV Upload -->
    <div class="card" id="csvCard">
        <div class="card-header">
            <h2 class="card-title">Donn√©es des participants</h2>
            <p class="card-description">Importez le fichier CSV contenant les informations des participants (nom, pr√©nom, email, etc.)</p>
        </div>
        <div class="upload-area" id="csvUploadArea">
            <div class="upload-icon">üìä</div>
            <div class="upload-text">Cliquez pour s√©lectionner ou glissez-d√©posez</div>
            <div class="upload-hint">Fichier CSV avec en-t√™tes</div>
            <input type="file" id="csvInput" accept=".csv">
        </div>
        <div id="csvStatus"></div>
    </div>

    <!-- Step 3: Preview & Generate -->
    <div class="card hidden" id="previewCard">
        <div class="card-header">
            <h2 class="card-title">Pr√©visualisation et g√©n√©ration</h2>
            <p class="card-description">S√©lectionnez un participant pour pr√©visualiser son badge</p>
        </div>

        <div class="select-wrapper">
            <select id="participantSelect">
                <option value="">S√©lectionner un participant...</option>
            </select>
        </div>

        <div class="preview-area">
            <canvas id="badgeCanvas"></canvas>
        </div>

        <div class="actions">
            <button class="btn btn-secondary" id="downloadBtn" disabled>
                <span>‚¨á</span> T√©l√©charger ce badge (PNG)
            </button>
            <button class="btn btn-primary" id="downloadAllBtn" disabled>
                <span>üì¶</span> T√©l√©charger tous les badges (PDF)
            </button>
        </div>
    </div>

    <div id="qr-hidden"></div>
</div>

<script>
    const csvInput = document.getElementById('csvInput');
    const bgInput = document.getElementById('bgInput');
    const participantSelect = document.getElementById('participantSelect');
    const canvas = document.getElementById('badgeCanvas');
    const ctx = canvas.getContext('2d');
    const downloadBtn = document.getElementById('downloadBtn');
    
    let participants = [];
    let templateImg = new Image();
    let qrLogoImg = new Image();

    // Charger le logo pour le QR Code depuis le fichier local
    qrLogoImg.src = "logo-qr.png";

    // Syst√®me de d√©tection automatique des colonnes CSV
    const columnMappings = {
        prenom: ['Pr√©noms', 'Pr√©nom', 'prenom', 'First Name', 'first_name', 'firstname', 'FirstName'],
        nom: ['Noms', 'Nom', 'nom', 'Last Name', 'last_name', 'lastname', 'LastName'],
        nomComplet: ['Nom complet', 'Full Name', 'fullname', 'Name', 'name'],
        email: ['Mail', 'Email', 'email', 'E-mail', 'e-mail', 'Quel est votre email ?', 'Adresse email'],
        tel: ['Tel', 'T√©l√©phone', 'Telephone', 'Phone', 'phone', 'Quel est votre num√©ro de t√©l√©phone ?', 'phone_number', 'PhoneNumber'],
        role: ['R√¥le', 'Role', 'role', 'Fonction', 'Function', 'fonction', 'Statut actuel', 'Title', 'Position', 'Job Title'],
        pole: ['Pole', 'P√¥le', 'pole', 'Organisation', 'Organization', 'organisation', 'organization', 'What company or organization are you a part of, if any?', 'Domaine d\'activit√© / d\'√©tude', 'Company', 'Entreprise']
    };

    // Fonction pour r√©cup√©rer intelligemment une valeur depuis un participant
    function smartGetField(participant, fieldType) {
        const possibleColumns = columnMappings[fieldType] || [];

        for (let columnName of possibleColumns) {
            if (participant[columnName] !== undefined && participant[columnName] !== null && participant[columnName] !== '') {
                return participant[columnName];
            }
        }

        // Cas sp√©cial : si on cherche pr√©nom ou nom et qu'on n'a que le nom complet
        if (fieldType === 'prenom' || fieldType === 'nom') {
            // V√©rifier si on a des colonnes pr√©nom/nom (sans appeler smartGetField pour √©viter la r√©cursion)
            let hasPrenomOrNom = false;
            for (let col of [...columnMappings.prenom, ...columnMappings.nom]) {
                if (participant[col]) {
                    hasPrenomOrNom = true;
                    break;
                }
            }

            // Si on n'a ni pr√©nom ni nom, essayer de splitter le nom complet
            if (!hasPrenomOrNom) {
                for (let col of columnMappings.nomComplet) {
                    const fullName = participant[col];
                    if (fullName && fullName.trim()) {
                        const parts = fullName.trim().split(/\s+/);
                        if (fieldType === 'prenom') {
                            return parts.slice(0, -1).join(' '); // Tout sauf le dernier mot
                        } else if (fieldType === 'nom') {
                            return parts[parts.length - 1]; // Dernier mot
                        }
                    }
                }
            }
        }

        return "";
    }

    // Step management
    function updateStep(stepNumber, participantCount = 0) {
        const progressIndicator = document.getElementById('progressIndicator');
        const stepTexts = [
            '',
            '√âtape 1/3 : Charger le template',
            '√âtape 2/3 : Importer les donn√©es',
            '√âtape 3/3 : G√©n√©rer les badges'
        ];

        let progressHTML = stepTexts[stepNumber] || '';

        // Add participant count badge if we have participants
        if (stepNumber === 3 && participantCount > 0) {
            progressHTML += ` <span class="participant-count">${participantCount} participant${participantCount > 1 ? 's' : ''}</span>`;
        }

        progressIndicator.innerHTML = progressHTML;

        // Hide completed cards
        if (stepNumber > 1) {
            document.getElementById('templateCard').classList.add('hidden');
        }
        if (stepNumber > 2) {
            document.getElementById('csvCard').classList.add('hidden');
        }
    }

    function showStatus(elementId, message, type = 'success') {
        const statusEl = document.getElementById(elementId);
        statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // Template upload with drag & drop
    const templateUploadArea = document.getElementById('templateUploadArea');

    templateUploadArea.addEventListener('click', () => bgInput.click());

    templateUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        templateUploadArea.classList.add('active');
    });

    templateUploadArea.addEventListener('dragleave', () => {
        templateUploadArea.classList.remove('active');
    });

    templateUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        templateUploadArea.classList.remove('active');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            bgInput.files = e.dataTransfer.files;
            bgInput.dispatchEvent(new Event('change'));
        }
    });

    bgInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        showStatus('templateStatus', '‚è≥ Chargement du template...', 'warning');

        const reader = new FileReader();
        reader.onload = (event) => {
            templateImg.src = event.target.result;
            templateImg.onload = () => {
                canvas.width = templateImg.width;
                canvas.height = templateImg.height;
                ctx.drawImage(templateImg, 0, 0);

                showStatus('templateStatus', `‚úì Template charg√© (${canvas.width}x${canvas.height}px)`, 'success');
                updateStep(2);
            };
        };
        reader.readAsDataURL(file);
    };

    // CSV upload with drag & drop
    const csvUploadArea = document.getElementById('csvUploadArea');

    csvUploadArea.addEventListener('click', () => csvInput.click());

    csvUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        csvUploadArea.classList.add('active');
    });

    csvUploadArea.addEventListener('dragleave', () => {
        csvUploadArea.classList.remove('active');
    });

    csvUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        csvUploadArea.classList.remove('active');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.csv')) {
            csvInput.files = e.dataTransfer.files;
            csvInput.dispatchEvent(new Event('change'));
        }
    });

    csvInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        showStatus('csvStatus', '‚è≥ Analyse du fichier CSV...', 'warning');

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            encoding: "UTF-8",
            transformHeader: h => h.trim().replace(/^\ufeff/, ""),
            complete: function(results) {
                participants = results.data;

                if (participants.length === 0) {
                    showStatus('csvStatus', '‚ö† Aucune donn√©e trouv√©e dans le CSV', 'error');
                    return;
                }

                showStatus('csvStatus', `‚úì ${participants.length} participant(s) charg√©(s)`, 'success');
                populateSelect();

                // Show preview card
                document.getElementById('previewCard').classList.remove('hidden');
                updateStep(3, participants.length);

                // Enable download all button
                document.getElementById('downloadAllBtn').disabled = false;

                // Auto-select first participant
                if (participants.length > 0) {
                    participantSelect.value = '0';
                    participantSelect.dispatchEvent(new Event('change'));
                }
            },
            error: function(error) {
                showStatus('csvStatus', `‚úó Erreur: ${error.message}`, 'error');
            }
        });
    };

    function populateSelect() {
        participantSelect.innerHTML = '<option value="">S√©lectionner un participant...</option>';
        participants.forEach((p, index) => {
            let option = document.createElement('option');
            option.value = index;

            // Utilisation du syst√®me de d√©tection intelligent
            const prenom = smartGetField(p, 'prenom');
            const nom = smartGetField(p, 'nom');
            const displayName = `${prenom} ${nom}`.trim();

            option.textContent = displayName || `Participant ${index + 1}`;
            participantSelect.appendChild(option);
        });
    }

    // Initialize first step as active
    updateStep(1);

    // Fonction pour capitaliser (premi√®re lettre majuscule, reste minuscules)
    function capitalize(str) {
        if (!str) return "";
        return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
    }

    // Fonction pour retirer les accents (pour QR Code seulement)
    function removeAccents(str) {
        if (!str) return "";
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // Fonction pour d√©couper le texte trop long en plusieurs lignes
    function splitTextToFit(text, maxWidth, maxChars = null) {
        // Nettoyer le texte : trim et remplacer espaces multiples par un seul espace
        const cleanText = text.trim().replace(/\s+/g, ' ');
        const words = cleanText.split(' ').filter(word => word.length > 0); // Filtrer les mots vides

        if (words.length === 0) return [];

        const lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
            const testLine = currentLine + ' ' + words[i];
            const metrics = ctx.measureText(testLine);

            // V√©rifier √† la fois la largeur ET le nombre de caract√®res
            const exceedsWidth = metrics.width > maxWidth;
            const exceedsChars = maxChars && testLine.length > maxChars;

            if (exceedsWidth || exceedsChars) {
                lines.push(currentLine);
                currentLine = words[i];
            } else {
                currentLine = testLine;
            }
        }
        lines.push(currentLine);
        return lines;
    }

    // Fonction pour dessiner du texte multiligne et retourner la position Y finale
    function drawMultilineText(text, x, startY, lineHeight, maxWidth, maxChars = null) {
        const lines = splitTextToFit(text, maxWidth, maxChars);
        let currentY = startY;

        lines.forEach((line, index) => {
            ctx.fillText(line, x, currentY);
            currentY += lineHeight;
        });

        return currentY; // Retourne la position Y apr√®s le dernier texte
    }

    participantSelect.onchange = function() {
        const p = participants[this.value];

        if (!p || !templateImg.src) {
            downloadBtn.disabled = true;
            return;
        }

        // Nettoyage et dessin du fond
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(templateImg, 0, 0);

        // --- PARTIE GAUCHE : TEXTE ---
        ctx.fillStyle = "#000000";
        ctx.textAlign = "left";

        // Largeur maximale pour le texte (45% de la largeur du canvas pour laisser de l'espace)
        const maxTextWidth = canvas.width * 0.45;
        const xPos = canvas.width * 0.05;
        let currentY = canvas.height * 0.44;

        // Pr√©nom (Gras, Capitalized) - Max 16 caract√®res par ligne
        const prenom = capitalize(smartGetField(p, 'prenom'));
        const prenomFontSize = canvas.height * 0.05;
        ctx.font = "bold " + prenomFontSize + "px Roboto, sans-serif";

        // Compter le nombre de lignes pour le pr√©nom
        const prenomLines = splitTextToFit(prenom, maxTextWidth, 16);
        currentY = drawMultilineText(prenom, xPos, currentY, prenomFontSize * 1.2, maxTextWidth, 16);

        // Nom (Gras, MAJUSCULES) - Max 12 caract√®res par ligne
        const nom = smartGetField(p, 'nom').toUpperCase();
        const nomFontSize = canvas.height * 0.05;
        ctx.font = "bold " + nomFontSize + "px Roboto, sans-serif";

        // Compter le nombre de lignes pour le nom
        const nomLines = splitTextToFit(nom, maxTextWidth, 12);
        currentY = drawMultilineText(nom, xPos, currentY, nomFontSize * 1.2, maxTextWidth, 12);

        // Calculer le nombre total de lignes
        const totalLines = prenomLines.length + nomLines.length;

        // Position fixe pour r√¥le et pole (comme si nom/pr√©nom prenaient toujours 3 lignes)
        // Calcul : position de d√©part + 3 lignes * hauteur de ligne + espacement
        const fixedRoleY = canvas.height * 0.44 + (3 * prenomFontSize * 1.2) + canvas.height * 0.02;

        // Fonction & Organisation (Normal) - Position fixe
        const detailsFontSize = canvas.height * 0.03;
        ctx.font = detailsFontSize + "px Roboto, sans-serif";

        // Changer la couleur du r√¥le en blanc si 4 lignes ou plus
        ctx.fillStyle = totalLines >= 4 ? "#ffffff" : "#3c4043";

        const role = smartGetField(p, 'role');
        let roleY = drawMultilineText(role, xPos, fixedRoleY, detailsFontSize * 1.3, maxTextWidth);

        // Le pole garde toujours sa couleur normale
        ctx.fillStyle = "#3c4043";
        const pole = smartGetField(p, 'pole');
        drawMultilineText(pole, xPos, roleY, detailsFontSize * 1.3, maxTextWidth);

        // --- PARTIE DROITE : QR CODE ---
        const qrContainer = document.getElementById('qr-hidden');
        qrContainer.innerHTML = "";

        // Taille du QR code r√©duite (environ 28% de la largeur du badge)
        const qrSize = canvas.width * 0.28;

        // Cr√©er une vCard optimis√©e manuellement au lieu d'utiliser celle du CSV
        // Appliquer le formatage et retirer les accents pour r√©duire la taille du QR Code
        const nomComplet = removeAccents(smartGetField(p, 'nom').toUpperCase());
        const prenomComplet = removeAccents(capitalize(smartGetField(p, 'prenom')));
        const tel = smartGetField(p, 'tel').trim();
        const email = removeAccents(smartGetField(p, 'email').trim());

        // Construire une vCard minimaliste
        let qrData = "BEGIN:VCARD\n";
        qrData += "VERSION:3.0\n";

        if (nomComplet || prenomComplet) {
            qrData += `N:${nomComplet};${prenomComplet}\n`;
            qrData += `FN:${prenomComplet} ${nomComplet}\n`;
        }

        if (tel) {
            qrData += `TEL;CELL:${tel}\n`;
        }

        if (email) {
            qrData += `EMAIL:${email}\n`;
        }

        qrData += "END:VCARD";

        // Normaliser les caract√®res pour assurer la compatibilit√© UTF-8
        if (qrData && typeof qrData === 'string') {
            qrData = qrData.normalize('NFC');
        }

        try {
            new QRCode(qrContainer, {
                text: qrData,
                width: qrSize,
                height: qrSize,
                colorDark : "#000000",
                colorLight : "rgba(255,255,255,0)", // Transparent
                correctLevel : QRCode.CorrectLevel.M  // M au lieu de H pour supporter les vCards plus longues
            });
        } catch (error) {
            // En cas d'erreur, essayer avec le niveau de correction le plus bas
            try {
                new QRCode(qrContainer, {
                    text: qrData,
                    width: qrSize,
                    height: qrSize,
                    colorDark : "#000000",
                    colorLight : "rgba(255,255,255,0)",
                    correctLevel : QRCode.CorrectLevel.L  // Low pour les vCards tr√®s longues
                });
            } catch (e2) {
                // Dernier recours : URL par d√©faut
                new QRCode(qrContainer, {
                    text: "https://devfest.gdglibreville.com",
                    width: qrSize,
                    height: qrSize,
                    colorDark : "#000000",
                    colorLight : "rgba(255,255,255,0)",
                    correctLevel : QRCode.CorrectLevel.M
                });
            }
        }

        setTimeout(() => {
            const qrImg = qrContainer.querySelector('img');

            if (!qrImg) {
                downloadBtn.disabled = false;
                return;
            }

            // CALCUL DU CENTRAGE
            // Centrer le QR code dans la partie droite du badge (entre 50% et 100%)
            const centerOfRightSide = (canvas.width * 0.75);
            const xPos = centerOfRightSide - (qrSize / 2);
            const yPos = canvas.height * 0.32; // Position verticale

            // Dessiner le QR code
            ctx.drawImage(qrImg, xPos, yPos, qrSize, qrSize);

            // Ajouter le logo au centre du QR Code (30% de la taille du QR pour meilleure visibilit√©)
            const logoSize = qrSize * 0.30;
            const logoX = xPos + (qrSize / 2) - (logoSize / 2);
            const logoY = yPos + (qrSize / 2) - (logoSize / 2);

            // Am√©liorer la qualit√© du rendu du logo
            if (qrLogoImg.complete && qrLogoImg.naturalHeight !== 0) {
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(qrLogoImg, logoX, logoY, logoSize, logoSize);
            }

            downloadBtn.disabled = false;
        }, 300);
    };

    downloadBtn.onclick = () => {
        const name = participantSelect.selectedOptions[0].textContent.replace(/\s+/g, '_');
        const link = document.createElement('a');
        link.download = `Badge_DevFest_${name}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    };

    // Fonction pour g√©n√©rer un badge pour un participant donn√©
    async function generateBadgeForParticipant(p) {
        return new Promise((resolve) => {
            // Nettoyage et dessin du fond
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(templateImg, 0, 0);

            // --- PARTIE GAUCHE : TEXTE ---
            ctx.fillStyle = "#000000";
            ctx.textAlign = "left";

            const maxTextWidth = canvas.width * 0.45;
            const xPos = canvas.width * 0.05;
            let currentY = canvas.height * 0.44;

            // Pr√©nom (Gras, Capitalized) - Max 16 caract√®res par ligne
            const prenom = capitalize(smartGetField(p, 'prenom'));
            const prenomFontSize = canvas.height * 0.05;
            ctx.font = "bold " + prenomFontSize + "px Roboto, sans-serif";

            const prenomLines = splitTextToFit(prenom, maxTextWidth, 16);
            currentY = drawMultilineText(prenom, xPos, currentY, prenomFontSize * 1.2, maxTextWidth, 16);

            // Nom (Gras, MAJUSCULES) - Max 12 caract√®res par ligne
            const nom = smartGetField(p, 'nom').toUpperCase();
            const nomFontSize = canvas.height * 0.05;
            ctx.font = "bold " + nomFontSize + "px Roboto, sans-serif";

            const nomLines = splitTextToFit(nom, maxTextWidth, 12);
            currentY = drawMultilineText(nom, xPos, currentY, nomFontSize * 1.2, maxTextWidth, 12);

            const totalLines = prenomLines.length + nomLines.length;

            const fixedRoleY = canvas.height * 0.44 + (3 * prenomFontSize * 1.2) + canvas.height * 0.02;

            const detailsFontSize = canvas.height * 0.03;
            ctx.font = detailsFontSize + "px Roboto, sans-serif";

            ctx.fillStyle = totalLines >= 4 ? "#ffffff" : "#3c4043";

            const role = smartGetField(p, 'role');
            let roleY = drawMultilineText(role, xPos, fixedRoleY, detailsFontSize * 1.3, maxTextWidth);

            ctx.fillStyle = "#3c4043";
            const pole = smartGetField(p, 'pole');
            drawMultilineText(pole, xPos, roleY, detailsFontSize * 1.3, maxTextWidth);

            // --- PARTIE DROITE : QR CODE ---
            const qrContainer = document.getElementById('qr-hidden');
            qrContainer.innerHTML = "";

            const qrSize = canvas.width * 0.28;

            const nomComplet = removeAccents(smartGetField(p, 'nom').toUpperCase());
            const prenomComplet = removeAccents(capitalize(smartGetField(p, 'prenom')));
            const tel = smartGetField(p, 'tel').trim();
            const email = removeAccents(smartGetField(p, 'email').trim());

            let qrData = "BEGIN:VCARD\n";
            qrData += "VERSION:3.0\n";

            if (nomComplet || prenomComplet) {
                qrData += `N:${nomComplet};${prenomComplet}\n`;
                qrData += `FN:${prenomComplet} ${nomComplet}\n`;
            }

            if (tel) {
                qrData += `TEL;CELL:${tel}\n`;
            }

            if (email) {
                qrData += `EMAIL:${email}\n`;
            }

            qrData += "END:VCARD";

            if (qrData && typeof qrData === 'string') {
                qrData = qrData.normalize('NFC');
            }

            try {
                new QRCode(qrContainer, {
                    text: qrData,
                    width: qrSize,
                    height: qrSize,
                    colorDark : "#000000",
                    colorLight : "rgba(255,255,255,0)",
                    correctLevel : QRCode.CorrectLevel.M
                });
            } catch (error) {
                try {
                    new QRCode(qrContainer, {
                        text: qrData,
                        width: qrSize,
                        height: qrSize,
                        colorDark : "#000000",
                        colorLight : "rgba(255,255,255,0)",
                        correctLevel : QRCode.CorrectLevel.L
                    });
                } catch (e2) {
                    new QRCode(qrContainer, {
                        text: "https://devfest.gdglibreville.com",
                        width: qrSize,
                        height: qrSize,
                        colorDark : "#000000",
                        colorLight : "rgba(255,255,255,0)",
                        correctLevel : QRCode.CorrectLevel.M
                    });
                }
            }

            setTimeout(() => {
                const qrImg = qrContainer.querySelector('img');

                if (qrImg) {
                    const centerOfRightSide = (canvas.width * 0.75);
                    const xPos = centerOfRightSide - (qrSize / 2);
                    const yPos = canvas.height * 0.32;

                    ctx.drawImage(qrImg, xPos, yPos, qrSize, qrSize);

                    const logoSize = qrSize * 0.30;
                    const logoX = xPos + (qrSize / 2) - (logoSize / 2);
                    const logoY = yPos + (qrSize / 2) - (logoSize / 2);

                    if (qrLogoImg.complete && qrLogoImg.naturalHeight !== 0) {
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(qrLogoImg, logoX, logoY, logoSize, logoSize);
                    }
                }

                resolve();
            }, 400);
        });
    }

    // Bouton pour t√©l√©charger tous les badges en PDF
    document.getElementById('downloadAllBtn').onclick = async () => {
        if (!templateImg.src || participants.length === 0) {
            return;
        }

        const btn = document.getElementById('downloadAllBtn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> G√©n√©ration en cours... (0/' + participants.length + ')';

        const { jsPDF } = window.jspdf;

        // Format A4 en points (72 DPI standard PDF)
        // A4 portrait : 595 x 842 points (210 x 297 mm)
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'a4'
        });

        const pageWidth = 595;   // A4 portrait
        const pageHeight = 842;

        // Calculer la taille des badges pour en mettre 2 par page (verticalement)
        // On garde un ratio et on centre les badges
        const margin = 20;
        const availableWidth = pageWidth - 2 * margin;
        const availableHeight = (pageHeight - 3 * margin) / 2; // Espace pour 2 badges verticalement

        // Calculer la taille du badge en maintenant le ratio
        const badgeRatio = canvas.width / canvas.height;
        let badgeWidth, badgeHeight;

        if (availableWidth / availableHeight > badgeRatio) {
            badgeHeight = availableHeight;
            badgeWidth = badgeHeight * badgeRatio;
        } else {
            badgeWidth = availableWidth;
            badgeHeight = badgeWidth / badgeRatio;
        }

        let badgeCount = 0;
        let pageCreated = false;

        for (let i = 0; i < participants.length; i++) {
            await generateBadgeForParticipant(participants[i]);

            const imgData = canvas.toDataURL('image/png');

            // Position du badge (0 = haut, 1 = bas)
            const position = badgeCount % 2;

            // Cr√©er une nouvelle page tous les 2 badges
            if (position === 0 && badgeCount > 0) {
                pdf.addPage('a4', 'portrait');
            }

            // Centrer horizontalement
            const xPos = margin + (availableWidth - badgeWidth) / 2;

            // Calculer position Y (haut ou bas)
            let yPos;
            if (position === 0) {
                // Badge du haut
                yPos = margin;
            } else {
                // Badge du bas
                yPos = margin * 2 + badgeHeight;
            }

            pdf.addImage(imgData, 'PNG', xPos, yPos, badgeWidth, badgeHeight);

            badgeCount++;
            btn.innerHTML = `<span class="loading"></span> G√©n√©ration en cours... (${i + 1}/${participants.length})`;
        }

        pdf.save('Badges_DevFest_2025.pdf');

        btn.disabled = false;
        btn.innerHTML = originalContent;

        const totalPages = Math.ceil(participants.length / 2);
        showStatus('csvStatus', `‚úì ${participants.length} badges g√©n√©r√©s sur ${totalPages} pages A4`, 'success');
    };
</script>

</body>
</html>